
<div class="portalHost" *ngIf="portal !== 1">
   <ng-container [cdkPortalOutlet]="_portal" ></ng-container>
</div>

<div class="portalHostSplit" *ngIf="portal === 1">
    <ng-container [cdkPortalOutlet]="_portal" ></ng-container>
 </div>

<ng-template cdkPortal #myTemplate="cdkPortal">
<div class="p-2">
<mat-card [ngStyle]="{'padding':'0px'}">
<mat-card-header [ngClass]="{'custom-card':true}">


  <!---
<div class="container-fluid">
  <div class="row">
    <div class="col-md-10 order-first">
      <div class="row">
        <div class="col-md-2 order-first">
            <div class="row">
              <div class="col">
                    <mat-form-field>      
                        <input  matInput placeholder="Buscar Orden" *ngIf="!isactiveSearch && datasourceLength == 0" disabled>
                        <input  matInput (keyup)="applyFilter()" placeholder="Buscar Orden" [(ngModel)]="filterValue" *ngIf="isactiveSearch && datasourceLength > 0">
                        <button mat-button *ngIf="filterValue && isLoadingResults" matSuffix mat-icon-button aria-label="Clear" >
                            <mat-spinner  mode="indeterminate" [strokeWidth]="1" [diameter]="17"></mat-spinner>
                        </button>
                        <button mat-button *ngIf="filterValue && !isLoadingResults" matSuffix mat-icon-button aria-label="Clear" (click)="filterValue=''">
                          <mat-icon>close</mat-icon>
                        </button>      
                        <mat-icon matSuffix *ngIf="!filterValue">search</mat-icon>
                    </mat-form-field>
              </div>
            </div>              
        </div>      

        <div class="col-md-10 order-md-last" >
            <div class="col-md-2" *ngIf="!show">
                  <button mat-icon-button [matMenuTriggerFor]="menu"
                    matTooltip="Filtrar datos."
                    [matTooltipPosition]="positionrightaction.value">
                    <mat-icon>filter_list</mat-icon>
                  </button>
                  
                  <mat-menu #menu="matMenu" [overlapTrigger]="false">
                    <form (keydown.tab)="$event.stopPropagation()">
                    <div class="container">    
                    <mat-accordion>
                      <mat-expansion-panel (click)="$event.stopPropagation(); false;" [expanded]="step === 0" (opened)="setStep(0)" class="no-shadow">
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            Filtrar Fecha
                          </mat-panel-title>
                        </mat-expansion-panel-header>
                  
                          <mat-form-field  class="full-width">
                            <mat-select placeholder="Seleccione" [(ngModel)]="selectedColumnnDate.fieldValue" name="Fecha">
                              <mat-option value="orders.create_at">Creado El</mat-option>
                              <mat-option value="orders.update_at">Editado El</mat-option>            
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field *ngIf="selectedColumnnDate.fieldValue"  class="full-width">
                            <input matInput [matDatepicker]="fecha1" placeholder="Desde" [(ngModel)]="selectedColumnnDate.columnValueDesde" disabled name="columnValueDesde" >
                            <mat-datepicker-toggle matSuffix [for]="fecha1"></mat-datepicker-toggle>
                            <mat-datepicker #fecha1 disabled="false"></mat-datepicker>
                          </mat-form-field>                    
                          <mat-form-field *ngIf="selectedColumnnDate.fieldValue"class="full-width" >
                            <input matInput [min]="selectedColumnnDate.columnValueDesde" [matDatepicker]="fecha2" placeholder="Hasta" [(ngModel)]="selectedColumnnDate.columnValueHasta" disabled  name="columnValueHasta">
                            <mat-datepicker-toggle matSuffix [for]="fecha2"></mat-datepicker-toggle>
                            <mat-datepicker #fecha2 disabled="false"></mat-datepicker>
                          </mat-form-field>
                      </mat-expansion-panel>
                                    
                      <mat-expansion-panel (click)="$event.stopPropagation(); false;" [expanded]="step === 1" (opened)="setStep(1)" class="no-shadow">
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            Filtrar Inspector
                          </mat-panel-title>
                        </mat-expansion-panel-header>                    
                            <mat-form-field class="full-width" >
                              <mat-select placeholder="Seleccione" [(ngModel)]="selectedColumnnUsuario.fieldValue" name="usuario">
                                <mat-option value="orders_details.assigned_to">Asignado A</mat-option>            
                                <mat-option value="orders_details.create_by">Creado Por</mat-option>
                                <mat-option value="orders_details.update_by">Editado Por</mat-option>            
                              </mat-select>
                            </mat-form-field>
                    
                            <mat-form-field class="full-width">
                              <mat-select [formControl]="inspectorCtrl"  placeholder="Inspector" #singleSelect   [(value)]="selectedColumnnUsuario.columnValue" >
                              <ngx-mat-select-search [formControl]="inspectorMultiFilterCtrl" ></ngx-mat-select-search>
                              <mat-option *ngFor="let inspector of filteredInspectorMulti | async" [value]="inspector.id">
                                {{inspector.name}}
                              </mat-option>
                              </mat-select>
                            </mat-form-field>                    
                      </mat-expansion-panel>    
                    </mat-accordion>
                    </div>
                  <hr>

                  <div mat-dialog-actions class="main-container">                  
                    <div class="container">      
                      <div class="row justify-content-center">
                      <div class="footer-button-row">
                
                      <button type="button" class="btn btn-primary btn-sm"  
                      (click)="search()"
                        [disabled]="!selectedColumnnDate.columnValueHasta  || !selectedColumnnDate.columnValueDesde || !selectedColumnnUsuario.fieldValue || !selectedColumnnUsuario.columnValue"
                      >
                      Buscar
                      </button>
                      
                      <button type="button" class="btn btn-secondary btn-sm" 
                      (click)="resetFilters()"
                      [disabled]="!selectedColumnnDate.columnValueHasta  && !selectedColumnnDate.columnValueDesde "
                      >Limpiar</button>
                
                      </div>
                      </div>
                    </div>
                  </div>                  
                  </form>
                  </mat-menu>                    
            </div>

            <div class="col-md-10" *ngIf="show">
              <mat-form-field class="margin" >
                  <mat-select placeholder="Filtro" [(ngModel)]="selectedColumnn.fieldValue">
                    <mat-option>Seleccione</mat-option>
                    <mat-option value="communes.commune_name">Comuna</mat-option>
                    <mat-option value="users.name">Creado Por</mat-option>            
                    <mat-option value="status.name">Estatus</mat-option>
                    <mat-option value="orders.order_number">N. Orden</mat-option>
                    <mat-option value="projects_customer.cc_number">N. Cliente</mat-option>
                    <mat-option value="provinces.province_name">Provincia</mat-option>
                    <mat-option value="regions.region_name">Región</mat-option>            
                    <p></p>
                    <div class="container">
                    <div class="button-row">
                    <button type="button" class="btn btn-secondary btn-sm" (click)="selectedColumnn.fieldValue=''">Limpiar</button>            
                    </div>
                    </div>
                    <p></p>
                  </mat-select>
              </mat-form-field>
        
          
              <mat-form-field *ngIf="selectedColumnn.fieldValue" class="margin">
              <input matInput placeholder="Valor" (keyup)="applyFilter()" [(ngModel)]="selectedColumnn.columnValue">
              <button mat-button *ngIf="selectedColumnn.columnValue" matSuffix mat-icon-button aria-label="Clear" (click)="selectedColumnn.columnValue=''">
                <mat-icon>close</mat-icon>
              </button>  
              </mat-form-field>
        
                              
              <mat-form-field class="margin" *ngIf="!selectedColumnn.fieldValue">
                    <mat-select [formControl]="regionMultiCtrl"  placeholder="Región" [multiple]="true" #multiSelect  >
                      <ngx-mat-select-search [formControl]="regionMultiFilterCtrl" ></ngx-mat-select-search>
                      <mat-option *ngFor="let region of filteredRegionMulti | async" [value]="region.name">
                        {{region.name}}
                      </mat-option>
                      <p></p>
                      <div class="container">
                      <div class="button-row">
                      <button type="button" class="btn btn-secondary btn-sm" (click)="resetRegionFilters()">Limpiar</button>
                      </div>
                      </div>
                      <p></p>
                    </mat-select>
              </mat-form-field>
            </div>          
        </div>                            
      </div>
    </div>
    
    <div class="col-md-2  order-md-last">
        <div class="row">

          <div class="col-md-2 order-first">
          </div>

          <div class="col-md-2 order-first">
          </div>
            
          <div class="col-md-2 order-first">
          </div>
                      
          <div class="col-md-2 order-first" >
              <button mat-icon-button  
              matTooltip="Exportar las actividades del día."
              [matTooltipPosition]="positionleftaction.value"
              (click)="ExportTOExcelDate(3)"
              (event)="$event.stopinmediatePropagation()"
              >
                <mat-icon>save_alt</mat-icon>
              </button>                            
          </div>

          <div class="col-md-2 order-first" >
              <button mat-icon-button [matMenuTriggerFor]="menuviewselect" 
              matTooltip="Seleccione la operación que requiere."
              [matTooltipPosition]="positionleftaction.value"
              >
                <mat-icon>more_horiz</mat-icon>
              </button>
            
              <mat-menu #menuviewselect="matMenu" [overlapTrigger]="false">
                <button mat-menu-item (click)="toggleTemplate(3)">
                  <span >Cambiar Masivo</span>
                </button>
              </mat-menu>              
          </div>

          <div class="col-md-2 order-md-last" >
              <button mat-icon-button [matMenuTriggerFor]="menuview" 
              matTooltip="Cambiar vista."
              [matTooltipPosition]="positionleftaction.value"
              aria-label="Button that displays a tooltip that hides when scrolled out of the container"
              >
                <mat-icon>view_headline</mat-icon>
              </button>
            
              <mat-menu #menuview="matMenu" [overlapTrigger]="false">
                <button mat-menu-item (click)="toggleTemplate(0)">
                  <mat-icon class="material-icons md-20-color" *ngIf="portal ==0">view_list</mat-icon>
                  <mat-icon class="material-icons md-20" *ngIf="portal !== 0">view_list</mat-icon>      
                  <span >Vista Lista </span>
                </button>
                <button mat-menu-item (click)="toggleTemplate(1)">
                  <mat-icon class="material-icons md-20-color" *ngIf="portal ==1">vertical_split</mat-icon>
                  <mat-icon class="material-icons md-20" *ngIf="portal !== 1">vertical_split</mat-icon>
                  <span >Vista Detalle</span>
                </button>
                <button mat-menu-item (click)="toggleTemplate(2)">
                  <mat-icon class="material-icons md-20-color" *ngIf="portal ==2">view_week</mat-icon>
                  <mat-icon class="material-icons md-20" *ngIf="portal !== 2">view_week</mat-icon>
                  <span >Vista Tablero</span>
                </button>
              </mat-menu>              
          </div>
        </div>
    </div>


  </div>
</div>
--->


<table  cellspacing="0" border="0" class="main-table" width="100%" role="table" >
  <tr>
    <td>
    <mat-form-field>      
      <input  matInput placeholder="Buscar Orden" *ngIf="!isactiveSearch && datasourceLength == 0" disabled>
      <input  matInput (keyup)="applyFilter()" placeholder="Buscar Orden" [(ngModel)]="filterValue" *ngIf="isactiveSearch && datasourceLength > 0">
      <button mat-button *ngIf="filterValue && isLoadingResults" matSuffix mat-icon-button aria-label="Clear" >
          <mat-spinner  mode="indeterminate" [strokeWidth]="1" [diameter]="17"></mat-spinner>
      </button>
      <button mat-button *ngIf="filterValue && !isLoadingResults" matSuffix mat-icon-button aria-label="Clear" (click)="filterValue=''">
        <mat-icon>close</mat-icon>
      </button>      
      <mat-icon matSuffix *ngIf="!filterValue">search</mat-icon>
    </mat-form-field>
    </td>

<td width="1%"></td>

<td width="1%">

<mat-button-toggle-group appearance="legacy" name="fontStyle" aria-label="Font Style" (click)="toggle()" id="bt"  *ngIf="!show">
  <mat-button-toggle value="bold">Filtros<i class="material-icons">arrow_drop_down</i></mat-button-toggle>
</mat-button-toggle-group>

<mat-button-toggle-group appearance="legacy" name="fontStyle" aria-label="Font Style" (click)="toggle()" id="bt"  *ngIf="show">
  <mat-button-toggle value="bold">Filtros<i class="material-icons" style="color:blue">arrow_right</i></mat-button-toggle>
</mat-button-toggle-group>

</td>


<td width="1%" >
<button mat-icon-button [matMenuTriggerFor]="menu" *ngIf="!show"
  matTooltip="Filtrar datos."
  [matTooltipPosition]="positionrightaction.value">
  <mat-icon>filter_list</mat-icon>
</button>

<mat-menu #menu="matMenu" [overlapTrigger]="false">
  <form (keydown.tab)="$event.stopPropagation()">
  <div class="container">    
  <mat-accordion>
    <mat-expansion-panel (click)="$event.stopPropagation(); false;" [expanded]="step === 0" (opened)="setStep(0)" class="no-shadow">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Filtrar Fecha
        </mat-panel-title>
      </mat-expansion-panel-header>

        <mat-form-field  class="full-width">
          <mat-select placeholder="Seleccione" [(ngModel)]="selectedColumnnDate.fieldValue" name="Fecha">
            <mat-option value="orders.create_at">Creado El</mat-option>
            <mat-option value="orders.update_at">Editado El</mat-option>            
          </mat-select>
        </mat-form-field>


  

        <mat-form-field *ngIf="selectedColumnnDate.fieldValue"  class="full-width">
          <input matInput [matDatepicker]="fecha1" placeholder="Desde" [(ngModel)]="selectedColumnnDate.columnValueDesde" disabled name="columnValueDesde" >
          <mat-datepicker-toggle matSuffix [for]="fecha1"></mat-datepicker-toggle>
          <mat-datepicker #fecha1 disabled="false"></mat-datepicker>
        </mat-form-field>

 


        <mat-form-field *ngIf="selectedColumnnDate.fieldValue"class="full-width" >
          <input matInput [min]="selectedColumnnDate.columnValueDesde" [matDatepicker]="fecha2" placeholder="Hasta" [(ngModel)]="selectedColumnnDate.columnValueHasta" disabled  name="columnValueHasta">
          <mat-datepicker-toggle matSuffix [for]="fecha2"></mat-datepicker-toggle>
          <mat-datepicker #fecha2 disabled="false"></mat-datepicker>
        </mat-form-field>

  
    </mat-expansion-panel>


  <mat-expansion-panel (click)="$event.stopPropagation(); false;" [expanded]="step === 1" (opened)="setStep(1)" class="no-shadow">
    <mat-expansion-panel-header>
      <mat-panel-title>
        Filtrar Inspector
      </mat-panel-title>
    </mat-expansion-panel-header>

        <mat-form-field class="full-width" >
          <mat-select placeholder="Seleccione" [(ngModel)]="selectedColumnnUsuario.fieldValue" name="usuario">
            <mat-option value="orders_details.assigned_to">Asignado A</mat-option>            
            <mat-option value="orders_details.create_by">Creado Por</mat-option>
            <mat-option value="orders_details.update_by">Editado Por</mat-option>            
          </mat-select>
        </mat-form-field>

        <mat-form-field class="full-width">
          <mat-select [formControl]="inspectorCtrl"  placeholder="Inspector" #singleSelect   [(value)]="selectedColumnnUsuario.columnValue" >
          <ngx-mat-select-search [formControl]="inspectorMultiFilterCtrl" ></ngx-mat-select-search>
          <mat-option *ngFor="let inspector of filteredInspectorMulti | async" [value]="inspector.id">
            {{inspector.name}}
          </mat-option>
          </mat-select>
        </mat-form-field>


  </mat-expansion-panel>    
  </mat-accordion>
  </div>

  <hr>
  <div mat-dialog-actions class="main-container" >

    <div class="container">      
      <div class="row justify-content-center">
      <div class="footer-button-row">

       <button type="button" class="btn btn-primary btn-sm"  
       (click)="search()"
        [disabled]="!selectedColumnnDate.columnValueHasta  || !selectedColumnnDate.columnValueDesde || !selectedColumnnUsuario.fieldValue || !selectedColumnnUsuario.columnValue"
       >
       Buscar
       </button>
       
       <button type="button" class="btn btn-secondary btn-sm" 
       (click)="resetFilters()"
       [disabled]="!selectedColumnnDate.columnValueHasta  || !selectedColumnnDate.columnValueDesde "
       >Limpiar</button>

      </div>
      </div>
    </div>
  </div>

  </form>
</mat-menu>


</td>



<td width="80%" align="left">

<div class="container animated fadeIn" style="top: 56px; left: 256px; visibility: visible; position: sticky; display: inline-block; z-index: 1;" *ngIf="show">
    <div class="row">

        <div class="col-sm">
        <mat-form-field class="margin" >
            <mat-select placeholder="Rango Fecha" [(ngModel)]="selectedoption">
              <mat-option *ngFor="let k of filterallvalue" [value]="k.value">
                {{k.name}}
              </mat-option>
              <p></p>
              <div class="container">
              <div class="button-row">
                  <button type="button" class="btn btn-secondary btn-sm" (click)="selectedoption=0">Limpiar</button>            
              </div>
              </div>
              <p></p>      
            </mat-select>          
        </mat-form-field>        
        </div>

        <div class="col-sm" *ngIf="selectedoption == 0">
        <mat-form-field class="margin" >
          <mat-select placeholder="Filtro" [(ngModel)]="selectedColumnn.fieldValue">
            <mat-option>Seleccione</mat-option>
            <mat-option value="communes.commune_name">Comuna</mat-option>
            <mat-option value="users.name">Creado Por</mat-option>            
            <mat-option value="status.name">Estatus</mat-option>
            <mat-option value="orders.order_number">N. Orden</mat-option>
            <mat-option value="projects_customer.cc_number">N. Cliente</mat-option>
            <mat-option value="provinces.province_name">Provincia</mat-option>
            <mat-option value="regions.region_name">Región</mat-option>            
            <p></p>
            <div class="container">
            <div class="button-row">
            <button type="button" class="btn btn-secondary btn-sm" (click)="selectedColumnn.fieldValue=''">Limpiar</button>            
            </div>
            </div>
            <p></p>
          </mat-select>
        </mat-form-field>
        </div>

        <div class="col-sm" *ngIf="selectedColumnn.fieldValue">
        <mat-form-field *ngIf="selectedColumnn.fieldValue" class="margin">
            <input matInput placeholder="Valor" (keyup)="applyFilter()" [(ngModel)]="selectedColumnn.columnValue">
            <button mat-button *ngIf="selectedColumnn.columnValue" matSuffix mat-icon-button aria-label="Clear" (click)="selectedColumnn.columnValue=''">
              <mat-icon>close</mat-icon>
            </button>  
        </mat-form-field>
        </div>


        <div class="col-sm">
        <mat-form-field class="margin"  >
          <mat-select placeholder="Fecha" [(ngModel)]="selectedColumnnDate.fieldValue">
            <mat-option>Seleccione</mat-option>
            <mat-option value="orders.create_at">Creado El</mat-option>
            <mat-option value="orders.update_at">Editado El</mat-option>            
        <p></p>
        <div class="container">
        <div class="button-row">
            <button type="button" class="btn btn-secondary btn-sm" (click)="selectedColumnnDate.fieldValue=''">Limpiar</button>            
        </div>
        </div>
        <p></p>

          </mat-select>
        </mat-form-field>
        </div>


        <div class="col-sm" *ngIf="selectedColumnnDate.fieldValue">
        <mat-form-field *ngIf="selectedColumnnDate.fieldValue" class="margin" >
          <input matInput [matDatepicker]="fecha1" placeholder="Desde" [(ngModel)]="selectedColumnnDate.columnValueDesde"disabled>
          <mat-datepicker-toggle matSuffix [for]="fecha1"></mat-datepicker-toggle>
          <mat-datepicker #fecha1 disabled="false"></mat-datepicker>
        </mat-form-field>
        </div>


        <div class="col-sm" *ngIf="selectedColumnnDate.fieldValue">
        <mat-form-field *ngIf="selectedColumnnDate.fieldValue" class="margin">
          <input matInput [min]="selectedColumnnDate.columnValueDesde" [matDatepicker]="fecha2" placeholder="Hasta" [(ngModel)]="selectedColumnnDate.columnValueHasta" disabled >
          <mat-datepicker-toggle matSuffix [for]="fecha2"></mat-datepicker-toggle>
          <mat-datepicker #fecha2 disabled="false"></mat-datepicker>
        </mat-form-field>
        </div>

 
        <div class="col-sm" *ngIf="!selectedColumnn.fieldValue">
        <mat-form-field class="margin" *ngIf="!selectedColumnn.fieldValue">
            <mat-select [formControl]="regionMultiCtrl"  placeholder="Región" [multiple]="true" #multiSelect  >
              <ngx-mat-select-search [formControl]="regionMultiFilterCtrl" ></ngx-mat-select-search>
              <mat-option *ngFor="let region of filteredRegionMulti | async" [value]="region.name">
                {{region.name}}
              </mat-option>
              <p></p>
              <div class="container">
              <div class="button-row">
              <button type="button" class="btn btn-secondary btn-sm" (click)="resetRegionFilters()">Limpiar</button>
              </div>
              </div>
              <p></p>
            </mat-select>
        </mat-form-field>
        </div>

  </div>
</div>
</td>


<td width="1%" *ngIf="show">
                <div class="btn-toolbar mb-2 mb-md-0" *ngIf="(selectedoption > 0) || (selectedColumnn.fieldValue && selectedColumnn.columnValue) || (selectedColumnnDate.fieldValue && selectedColumnnDate.columnValueDesde && selectedColumnnDate.columnValueHasta) || (regionMultiCtrl.value)">
                  <div class="btn-group mr-2" align="right">
       
                    <button type="button" class="btn btn-sm btn-outline-secondary"   (click)="search()">Buscar</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" (click)="resetFilters()">Limpiar</button>

                  </div>
                </div>



</td>

<td width="1%" >
  <button mat-icon-button  *ngIf="!show"
  matTooltip="Exportar las actividades del día."
  [matTooltipPosition]="positionleftaction.value"
  (click)="ExportTOExcelDate(3)"
  (event)="$event.stopinmediatePropagation()"
  >
    <mat-icon>save_alt</mat-icon>
  </button>  
</td>

<td width="1%" *ngIf="identity.role > 4">
  <button mat-icon-button [matMenuTriggerFor]="menuviewselect" *ngIf="!show"
  matTooltip="Seleccione la operación que requiere."
  [matTooltipPosition]="positionleftaction.value"
  >
    <mat-icon>more_horiz</mat-icon>
  </button>

  <mat-menu #menuviewselect="matMenu" [overlapTrigger]="false">
    <button mat-menu-item (click)="toggleTemplate(3)">
      <span >Cambiar Masivo</span>
    </button>
  </mat-menu>
</td>



<td width="1%" >
  <button mat-icon-button [matMenuTriggerFor]="menuview" *ngIf="!show"
  matTooltip="Cambiar vista."
  [matTooltipPosition]="positionleftaction.value"
  aria-label="Button that displays a tooltip that hides when scrolled out of the container"
  >
    <mat-icon>view_headline</mat-icon>
  </button>

  <mat-menu #menuview="matMenu" [overlapTrigger]="false">
    <button mat-menu-item (click)="toggleTemplate(0)">
      <mat-icon class="material-icons md-20-color" *ngIf="portal ==0">view_list</mat-icon>
      <mat-icon class="material-icons md-20" *ngIf="portal !== 0">view_list</mat-icon>      
      <span >Vista Lista </span>
    </button>
    <button mat-menu-item (click)="toggleTemplate(1)">
      <mat-icon class="material-icons md-20-color" *ngIf="portal ==1">vertical_split</mat-icon>
      <mat-icon class="material-icons md-20" *ngIf="portal !== 1">vertical_split</mat-icon>
      <span >Vista Detalle</span>
    </button>
    <button mat-menu-item (click)="toggleTemplate(2)">
      <mat-icon class="material-icons md-20-color" *ngIf="portal ==2">view_week</mat-icon>
      <mat-icon class="material-icons md-20" *ngIf="portal !== 2">view_week</mat-icon>
      <span >Vista Tablero</span>
    </button>
  </mat-menu>
</td>




</tr>
</table>


</mat-card-header>

<mat-card-content>
<div class="example-rate-limit-reached" *ngIf="isRateLimitReached">
  No se encontraron registros que coincidan con su búsqueda.
  <button mat-button color="primary" (click)="refreshTable()"> <mat-icon aria-label="Example icon-button with a heart icon" >sync</mat-icon> Refrescar</button>
</div>


<div class="example-container " >
<div class="example-loading-shade" *ngIf="isLoadingResults || isRateLimitReached">
  <app-loading *ngIf="isLoadingResults"></app-loading>
</div>

<div class="row" >
<div class="col-md-12"> 
  <mat-table #table  [dataSource]="dataSource" 
    matSort    
    (matSortChange)="handleSortChange($event)" 
    [matSortActive]="sort.active" 
    [matSortDirection]="sort.direction" 
    matSortDisableClear  
    [class.isMobile]="isMobile"
    >


  <ng-container matColumnDef="important" >
    <mat-header-cell *matHeaderCellDef mat-sort-header><i class="material-icons">unfold_more</i></mat-header-cell>
      <mat-cell *matCellDef="let order; let i = index" >
        <span class="mobile-label">Destacado:</span>
        <div  (click)="order.important=!order.important; onChangeIcon(order.important, category_id, order.order_id) ">
          <i class="material-icons md-color-checkbox" matTooltip="Destacado" [matTooltipPosition]="positiondatasourceaction.value" *ngIf="order.important">label_important</i>
          <i class="material-icons md-nocolor-checkbox" matTooltip="Sin destacar" [matTooltipPosition]="positiondatasourceaction.value" *ngIf="!order.important">label_important</i>
        </div>      
      </mat-cell>
  </ng-container>



  <ng-container matColumnDef="order_number"  >  
    <mat-header-cell *matHeaderCellDef mat-sort-header > N. Orden </mat-header-cell>
      <mat-cell *matCellDef="let order; let i = index" >
          <span class="mobile-label">N. Orden:</span>
          {{order.order_number}}
          <mat-icon class="material-icons md-13-color" *ngIf="order.imagen">image</mat-icon>        
          <mat-icon class="material-icons md-13-nocolor" *ngIf="!order.imagen">image</mat-icon>                
        </mat-cell>
  </ng-container>


    
  <ng-container matColumnDef="cc_number">
    <mat-header-cell *matHeaderCellDef mat-sort-header> N. Cliente </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">N. Cliente:</span>
        {{order.cc_number}} 
      </mat-cell>
  </ng-container>


  <ng-container matColumnDef="region"  >
    <mat-header-cell *matHeaderCellDef mat-sort-header  > Región </mat-header-cell>
      <mat-cell *matCellDef="let order" [ngClass]="{'hidden-item': true}"> 
          <span class="mobile-label">Región:</span>
        {{order.region}} 
      </mat-cell>
  </ng-container>

  <ng-container matColumnDef="provincia"  >
    <mat-header-cell *matHeaderCellDef mat-sort-header  > Provincia </mat-header-cell>
      <mat-cell *matCellDef="let order" [ngClass]="{'hidden-item': true}"> 
          <span class="mobile-label">Provincia:</span>
        {{order.provincia}} 
      </mat-cell>
  </ng-container>


  <ng-container matColumnDef="comuna"  >
    <mat-header-cell *matHeaderCellDef mat-sort-header  > Comuna </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">Comuna:</span>
        {{order.comuna}} 
      </mat-cell>
  </ng-container>

  <ng-container matColumnDef="orderdetail_direccion">
    <mat-header-cell *matHeaderCellDef mat-sort-header  > Realizado En </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">Realizado En:</span>
        {{order.orderdetail_direccion}} 
      </mat-cell>
  </ng-container>


  <ng-container matColumnDef="direccion">
    <mat-header-cell *matHeaderCellDef mat-sort-header  > Ubicación </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">Ubicación:</span>
        {{order.direccion}} 
      </mat-cell>
  </ng-container>



  <ng-container matColumnDef="servicetype" >
    <mat-header-cell *matHeaderCellDef mat-sort-header> Tipo Servicio </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">T. Serv.:</span>
        {{order.servicetype}}     
      </mat-cell>
  </ng-container>



  <ng-container matColumnDef="user" >
    <mat-header-cell *matHeaderCellDef mat-sort-header> Informador </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">Informador:</span>
        {{order.user}} 
      </mat-cell>
  </ng-container>

  <ng-container matColumnDef="userupdate" >
    <mat-header-cell *matHeaderCellDef mat-sort-header> Editado </mat-header-cell>
      <mat-cell *matCellDef="let order"> {{order.userupdate}} </mat-cell>
  </ng-container>

  <ng-container matColumnDef="userassigned" >
    <mat-header-cell *matHeaderCellDef mat-sort-header> Responsable</mat-header-cell>
      <mat-cell *matCellDef="let order" > 
        <span class="mobile-label">Responsable:</span>
        <span *ngIf="order && order.userassigned">
          <div *ngIf="identity && identity.role < 7">{{order.userassigned}}</div>
          <a class="nav-link pointer" href="javascript:;" (click)="showModal(order.assigned_to)" *ngIf="_userService.isRole(7)">
              {{order.userassigned}}
          </a>
        </span>
        <em *ngIf="order && !order.userassigned" style="color:#D3D3D3">sin asignar</em>
      </mat-cell>
  </ng-container>


  <ng-container matColumnDef="create_at" >
    <mat-header-cell *matHeaderCellDef mat-sort-header> Creado El </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">Creado El:</span>
        {{order.create_at }}
      </mat-cell>
  </ng-container>


  <ng-container matColumnDef="update_at" >
      <mat-header-cell *matHeaderCellDef mat-sort-header>Editado El:</mat-header-cell>
        <mat-cell *matCellDef="let order">
          <span class="mobile-label">Editado El:</span>
          {{order.update_at }}
        </mat-cell>
  </ng-container>
  

  <ng-container matColumnDef="time" >
    <mat-header-cell *matHeaderCellDef mat-sort-header> T. Ejecución </mat-header-cell>
      <mat-cell *matCellDef="let order"> 
          <span class="mobile-label">T. Ejecución:</span>
        <div *ngIf="order.time">{{order.time }}</div></mat-cell>
  </ng-container>

  <ng-container matColumnDef="atentiontime" >
      <mat-header-cell *matHeaderCellDef mat-sort-header>T. Atención</mat-header-cell>
        <mat-cell *matCellDef="let order">
          <span class="mobile-label">T. Atención:</span>
          <app-viewordertimespent [timefrom]="order.create_at"  [timeuntil]="order.update_at"></app-viewordertimespent>
        </mat-cell>
  </ng-container>
  


  <ng-container matColumnDef="estatus" >
    <mat-header-cell *matHeaderCellDef mat-sort-header> Estatus </mat-header-cell>
    <mat-cell *matCellDef="let order; let i = index" >
        <span class="mobile-label">Estatus:</span>
      <mat-chip-list>
          <mat-chip *ngIf="order.label==1" selected color="warn">
            {{order.estatus}}
          </mat-chip>

          <mat-chip *ngIf="order.label==2" selected color="primary">
            {{order.estatus}}
          </mat-chip>

          <mat-chip *ngIf="order.label==3" selected color="accent">
            {{order.estatus}}
          </mat-chip>
      </mat-chip-list>
    </mat-cell>
  </ng-container>

  <!-- actions -->
      <ng-container matColumnDef="actions" >
        <mat-header-cell *matHeaderCellDef >        
          <button mat-icon-button color="primary" (click)="addNew(id, category_id)" *ngIf="_userService.isRole(4) && id && category_id"
          matTooltip="Agregar orden."
          [matTooltipPosition]="positionheaderaction.value"
          >
            <mat-icon  >add</mat-icon>
          </button>
          <button mat-icon-button color="primary" (click)="refreshTable()"
          matTooltip="Refrescar datos."
          [matTooltipPosition]="positionheaderaction.value"
          *ngIf="_userService.isRole(4) && id && category_id"
          >
            <mat-icon  >refresh</mat-icon>
          </button>
          <button mat-icon-button color="primary" (click)="settings(columnsOrderToDisplay)"
          matTooltip="Ver/Ocultar columnas."
          [matTooltipPosition]="positionheaderaction.value"
          *ngIf="_userService.isRole(4) && id && category_id"
          >
          <mat-icon >settings</mat-icon>
          </button>



          <button mat-icon-button color="primary" [matMenuTriggerFor]="menuviewselectaction"  *ngIf="_userService.isRole(4) && id && category_id">
          <mat-icon class="material-icons">publish</mat-icon>
          </button>

          <mat-menu #menuviewselectaction="matMenu" [overlapTrigger]="false" >
            <button mat-menu-item *ngIf="_userService.isRole(8)" (click)="publish()" matTooltip="Almacenar información." [matTooltipPosition]="positionheaderaction.value">
              <span >Documentos de Proyecto</span>
            </button>            
            <button mat-menu-item (click)="addDoc()">
              <span >Adjuntar Documento</span>
            </button>
          </mat-menu>


        </mat-header-cell>
        <mat-cell *matCellDef="let order; let i = index" >
          <button mat-icon-button color="primary" *ngIf="_userService.isRole(4)" (click)="startEdit(order.order_id, order.order_number, order.category_id, order.customer_id, order.cc_number, order.servicetype_id, order.status_id, order.assigned_to, order.order_date, order.required_date, order.vencimiento_date, order.leido_por, order.observation, order.create_at)"
          matTooltip="Editar orden."
          [matTooltipPosition]="positiondatasourceaction.value"
          
          >
            <mat-icon class="material-icons md-color" aria-label="Edit" *ngIf="i != indexitem">edit</mat-icon>          
            <mat-icon aria-label="Edit" *ngIf="i == indexitem">edit</mat-icon>          
          </button>

          <button mat-icon-button color="warn" *ngIf="_userService.isRole(5)" (click)="deleteItem(order.order_id, order.order_number, order.category_id, order.customer_id, order.cc_number, order.servicetype_id, order.status_id,  order.estatus, order.order_date, order.required_date, order.observation, order.create_at, order.project_name, order.service_name, order.servicetype )"
          matTooltip="Eliminar orden."
          [matTooltipPosition]="positiondatasourceaction.value"
          >
            <mat-icon class="material-icons md-color" aria-label="Delete" *ngIf="i != indexitem">delete</mat-icon>
            <mat-icon aria-label="Delete" *ngIf="i == indexitem">delete</mat-icon>
          </button>

          <button mat-icon-button color="" (click)="showItem(order.order_id, order.order_number, order.category_id, order.customer_id, order.cc_number, order.servicetype_id, order.status_id, order.estatus, order.order_date, order.required_date, order.vencimiento_date, order.observation, order.create_at, order.user, order.project_name, order.service_name, order.servicetype, order.update_at, order.userupdate, order.region, order.provincia, order.comuna, order.direccion)"
          matTooltip="Ver orden."
          [matTooltipPosition]="positiondatasourceaction.value"
          >
            <mat-icon class="material-icons md-color" aria-label="launch" *ngIf="i != indexitem">launch</mat-icon>
            <mat-icon aria-label="launch" *ngIf="i == indexitem">launch</mat-icon>
          </button>


          <button mat-icon-button [matMenuTriggerFor]="menuviewselectorder" *ngIf="_userService.isRole(7)"  matTooltip="Acciones (Presiona para acceder a las acciones de la incidencia)" [matTooltipPosition]="positionheaderaction.value">
            <mat-icon class="material-icons md-color" aria-label="launch" *ngIf="i != indexitem">more_horiz</mat-icon>
            <mat-icon aria-label="launch" *ngIf="i == indexitem">more_horiz</mat-icon>
          </button>
        
          <mat-menu #menuviewselectorder="matMenu" [overlapTrigger]="false">
            <button mat-menu-item (click)="publishOrder(order.order_id)" *ngIf="_userService.isRole(8)">
              <span >Documentos</span>
            </button>
            <button mat-menu-item (click)="addJob(order.order_id, order.order_number, order.estatus, order.servicetype_id)">
              <span >Registrar trabajo</span>
            </button>
            <button mat-menu-item (click)="SendOrderByEmail(order.order_id, order.order_number, order.estatus, order.servicetype_id)">
              <span >Enviar por correo</span>
            </button>
          </mat-menu>        




            
        </mat-cell>
      </ng-container>


  <mat-header-row *matHeaderRowDef="columnsOrderToDisplay" color="primary" ></mat-header-row>
  <mat-row *matRowDef="let order; let i = index; columns: columnsOrderToDisplay;" (click)="setClickedRow(i, order.order_id)" (mouseenter)="hoverIn(i)" (mouseleave)="hoverOut(i)" [class.active]="i == selectedRow"></mat-row>



  </mat-table>
</div>
</div>
<mat-paginator    [length]="resultsLength"
                  [pageSize]="pageSize"
                  [pageSizeOptions]="pageSizeOptions"
                  (page)="onPaginateChange($event)"
                  [showFirstLastButtons]="true" 
                  [ngClass]="{'custom-card':true}"
></mat-paginator>    
</div>

<P></P>
 

<div  style="float:right">
<div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
    <div class="btn-group mr-2" role="group" aria-label="First group" *ngIf="!isRateLimitReached">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" (click)="openDialog()">
                    <span data-feather="calendar"></span>
                    ZIP
                  </button>
    </div>
    <div class="btn-group mr-2" role="group" aria-label="Second group" *ngIf="!isRateLimitReached">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" (click)="downloadPDF()">
                    <span data-feather="calendar"></span>
                    PDF
                  </button>
    </div>
    <div class="btn-group mr-2" role="group" aria-label="Second group">




          <div class="btn-group" *ngIf="!isRateLimitReached">
 
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" [matMenuTriggerFor]="menucsv"><span data-feather="CSV"></span>CSV</button>
                <mat-menu #menucsv="matMenu">
                <button mat-menu-item (click)="openDialogCsv()"><span data-feather="csv"></span>Buscar</button>

                <button mat-menu-item (click)="ExportTOExcelClient(0)"><span data-feather="csv"></span>Formato Original</button>

                <button mat-menu-item (click)="ExportTOExcelClient(1)"><span data-feather="csv"></span>Formato Mayúscula</button>


                </mat-menu>

          </div>

    </div>
  </div>
</div>
</mat-card-content>
</mat-card>
</div>
</ng-template>


<ng-template cdkPortal #myTemplate2="cdkPortal" >
  <div style="height: 100%;">
    <as-split  direction="horizontal" unit="percent" restrictMove="false" (dragEnd)="log($event)" >        
        <as-split-area size="70" minsize="50" >
        <ng-container [cdkPortalOutlet]="_home" ></ng-container>
        </as-split-area>
        
        <as-split-area size="30" minsize="30" maxsize="30" >
        <div class="p-2">
        <app-vieworderdetail [orderid]="order_id"></app-vieworderdetail>
        </div>
    </as-split-area>

   </as-split>          
  </div>
</ng-template>


<ng-template cdkPortal #myTemplate3="cdkPortal" >
  <div style="height: 100%">
    <app-tablero [id]="service_id" (portalevent) = "toggleTemplate( $event )" [view]="portal"></app-tablero>
  </div>
</ng-template>


<ng-template cdkPortal #myTemplate4="cdkPortal" >
  <div style="height: 100%">
    <app-vieworderserviceselect [id]="id" (portalevent) = "toggleTemplate( $event )" [view]="portal" *ngIf="identity.role > 4"></app-vieworderserviceselect>
  </div>
</ng-template>

<app-user-job-profile [id]="assigned_to" *ngIf="assigned_to && assigned_to > 0"></app-user-job-profile>

